FROM oven/bun:1-alpine

WORKDIR /app

COPY package*.json bun.lockb drizzle.config.ts .

RUN bun install

COPY ./src ./src

ARG SETTINGS_TOKEN_HASH_SALT

ARG SETTINGS_TOKEN_IV

ARG POSTGRES_HOST

ARG POSTGRES_PORT

ARG POSTGRES_USER

ARG POSTGRES_DB

ARG POSTGRES_PASSWORD 

ARG API_PORT

ENV POSTGRES_HOST=$POSTGRES_HOST

ENV POSTGRES_PORT=$POSTGRES_PORT

ENV POSTGRES_USER=$POSTGRES_USER

ENV POSTGRES_DB=$POSTGRES_DB

ENV POSTGRES_PASSWORD=$POSTGRES_PASSWORD 

ENV API_PORT=$API_PORT 

ENV SETTINGS_TOKEN_HASH_SALT=${SETTINGS_TOKEN_HASH_SALT}

ENV SETTINGS_TOKEN_IV=${SETTINGS_TOKEN_IV}

RUN bun run build

EXPOSE $API_PORT

COPY start.sh .

CMD ["./start.sh"]

